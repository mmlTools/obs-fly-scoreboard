name: Build & Release (Windows / macOS / Ubuntu)

on:
  push:
    branches: [main]
    paths-ignore:
      - "**/*.md"
      - "docs/**"
  workflow_dispatch:

permissions:
  contents: write

env:
  BUILD_TYPE: Release
  ARTIFACT_BASENAME: obs-fly-scoreboard
  VERSION: v${{ github.run_number }}

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [windows-2022, macos-15, ubuntu-22.04]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --------------------- WINDOWS ---------------------
      - name: Set up MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install CMake (Windows)
        if: runner.os == 'Windows'
        run: choco install -y cmake --installargs '"ADD_CMAKE_TO_PATH=System"'

      - name: Show tool versions (Windows)
        if: runner.os == 'Windows'
        run: |
          cmake --version
          cl 2>&1 || ver

      - name: Configure (Windows, VS2022)
        if: runner.os == 'Windows'
        run: |
          cmake -S . -B build ^
            -G "Visual Studio 17 2022" -A x64 ^
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        shell: cmd

      - name: Build (Windows)
        if: runner.os == 'Windows'
        run: cmake --build build --config ${{ env.BUILD_TYPE }}

      # --------------------- macOS ---------------------
      - name: Select Xcode 16 (macOS)
        if: runner.os == 'macOS'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16"

      - name: Install deps (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install cmake qt@6
          echo "CMAKE_PREFIX_PATH=$(brew --prefix qt@6)" >> $GITHUB_ENV
          cmake --version
          xcodebuild -version
          xcrun --show-sdk-version

      - name: Configure (macOS, Xcode)
        if: runner.os == 'macOS'
        run: |
          cmake -S . -B build -G Xcode \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_PREFIX_PATH="${{ env.CMAKE_PREFIX_PATH }}" \
            -DCMAKE_CXX_FLAGS="-Wno-error=deprecated-this-capture"
          # If needed, force arch:
          # -DCMAKE_OSX_ARCHITECTURES=arm64

      - name: Build (macOS)
        if: runner.os == 'macOS'
        run: cmake --build build --config ${{ env.BUILD_TYPE }}

      # --------------------- Ubuntu ---------------------
      - name: Install deps (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository -y ppa:obsproject/obs-studio
          sudo apt-get update
          # Core build tools
          sudo apt-get install -y cmake ninja-build build-essential pkg-config
          # OpenGL headers for FindOpenGL
          sudo apt-get install -y libgl1-mesa-dev
          # OBS SDK
          sudo apt-get install -y libobs-dev
          # Qt5
          sudo apt-get install -y qtbase5-dev qtbase5-dev-tools
          # Help CMake find LibObs & Qt5
          if [ -f /usr/lib/x86_64-linux-gnu/cmake/LibObs/LibObsConfig.cmake ]; then
            echo "LibObs_DIR=/usr/lib/x86_64-linux-gnu/cmake/LibObs" >> $GITHUB_ENV
          fi
          if [ -d /usr/lib/x86_64-linux-gnu/cmake/Qt5 ]; then
            echo "Qt5_DIR=/usr/lib/x86_64-linux-gnu/cmake/Qt5" >> $GITHUB_ENV
          fi
          cmake --version

      - name: Configure (Ubuntu, Ninja)
        if: runner.os == 'Linux'
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DLibObs_DIR=${{ env.LibObs_DIR }} \
            -DQt5_DIR=${{ env.Qt5_DIR }}

      - name: Build (Ubuntu)
        if: runner.os == 'Linux'
        run: cmake --build build --config ${{ env.BUILD_TYPE }}

      # --------------------- Package per-OS ---------------------
      - name: Show built binaries
        shell: bash
        run: |
          echo "Built binaries:"
          find build -maxdepth 4 -type f \( -name "*.dll" -o -name "*.so" -o -name "*.dylib" \) -print || true

      - name: Package artifact
        shell: bash
        run: |
          set -euo pipefail
          OS_TAG=$(echo "${{ matrix.os }}" | sed 's/-[0-9.]*$//')  # windows / macos / ubuntu
          PKG_DIR="package-${OS_TAG}"
          mkdir -p "$PKG_DIR"

          # Copy plugin binary (OBS plugins on macOS are .so)
          if [[ "$OS_TAG" == "windows" ]]; then
            find build -type f \( -iname "*obs-fly-scoreboard*.dll" -o -iname "*obs-fly-scoreboard*.pdb" \) \
              -print -exec cp {} "$PKG_DIR"/ \; || true
          elif [[ "$OS_TAG" == "macos" ]]; then
            find build -type f \( -iname "*obs-fly-scoreboard*.dylib" -o -iname "*obs-fly-scoreboard*.so" \) \
              -print -exec cp {} "$PKG_DIR"/ \; || true
          else
            find build -type f -iname "*obs-fly-scoreboard*.so" \
              -print -exec cp {} "$PKG_DIR"/ \; || true
          fi

          # Include plugin data folder (if you ship it)
          if [ -d "data/obs-plugins/obs-fly-scoreboard" ]; then
            mkdir -p "$PKG_DIR/data/obs-plugins"
            cp -R "data/obs-plugins/obs-fly-scoreboard" "$PKG_DIR/data/obs-plugins/"
          fi

          echo "Contents of $PKG_DIR:"
          find "$PKG_DIR" -maxdepth 4 -type f -print || true

          if ! find "$PKG_DIR" -type f | grep -q .; then
            echo "ERROR: No plugin files copied for $OS_TAG" >&2
            find build -maxdepth 4 -type f -print >&2 || true
            exit 1
          fi

          ZIP_NAME="${{ env.ARTIFACT_BASENAME }}-${OS_TAG}.zip"
          if command -v 7z >/dev/null 2>&1; then
            7z a -r "$ZIP_NAME" "$PKG_DIR" >/dev/null
          else
            zip -r "$ZIP_NAME" "$PKG_DIR" >/dev/null
          fi
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_BASENAME }}-${{ matrix.os }}
          path: ${{ env.ZIP_NAME }}

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (to manage the tag)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: List artifacts
        run: find ./artifacts -type f -maxdepth 3 -print

      - name: Ensure tag exists
        env:
          VERSION: ${{ env.VERSION }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f "$VERSION" "${GITHUB_SHA}"
          git push -f origin "$VERSION"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          target_commitish: ${{ github.sha }}
          name: "${{ env.ARTIFACT_BASENAME }} ${{ env.VERSION }}"
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            artifacts/**/obs-fly-scoreboard-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
